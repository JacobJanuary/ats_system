# üìä –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–£–î–ò–¢: –ú–∏–≥—Ä–∞—Ü–∏—è —Å smart_ml.predictions –Ω–∞ fas.scoring_history

## üéØ –†–ï–ó–Æ–ú–ï

–°–∏—Å—Ç–µ–º–∞ –¥–æ —Å–∏—Ö –ø–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à—É—é —Ç–∞–±–ª–∏—Ü—É `smart_ml.predictions` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É `fas.scoring_history`, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

## üìå –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

### –°—Ç–∞—Ä–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (smart_ml.predictions)
- **–¢–∞–±–ª–∏—Ü–∞**: `smart_ml.predictions`
- **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å**: –¢—Ä–µ–±—É–µ—Ç JOIN —Å `fas.scoring_history` —á–µ—Ä–µ–∑ `signal_id`
- **–ü—Ä–æ–±–ª–µ–º—ã**:
  - –î–≤–æ–π–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –¥–≤—É—Ö —Ç–∞–±–ª–∏—Ü
  - –£—Å—Ç–∞—Ä–µ–≤—à–∞—è –ª–æ–≥–∏–∫–∞
  - –í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö

### –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (fas.scoring_history)
- **–¢–∞–±–ª–∏—Ü–∞**: `fas.scoring_history`
- **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
  - –ü—Ä—è–º–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤
  - –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ scores
  - –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  - –ë–æ–ª–µ–µ –≥–∏–±–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

## ‚úÖ –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û

### 1. –°–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- **–§–∞–π–ª**: `database/models_v2.py`
- **–ö–ª–∞—Å—Å**: `TradingSignalV2`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π:
  - `total_score`
  - `pattern_score`
  - `indicator_score`
  - `score_week`
  - `score_month`
  - `recommended_action`

### 2. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- **–§–∞–π–ª**: `database/signal_repository_v2.py`
- **–ö–ª–∞—Å—Å**: `SignalRepositoryV2`
- –ú–µ—Ç–æ–¥—ã:
  - `get_unprocessed_signals_v2()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏–∑ fas.scoring_history
  - `get_unprocessed_signals_legacy()` - —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
  - `migrate_add_columns()` - –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º—É
- **–§–∞–π–ª**: `database/connection.py`
- –î–æ–±–∞–≤–ª–µ–Ω `signals_v2` —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- –§–ª–∞–≥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è: `USE_SCORING_HISTORY`

### 4. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `ats.signals`:
- `total_score`
- `score_week`
- `score_month`
- `recommended_action`

## üîç –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
**–ü—Ä–∏—á–∏–Ω–∞**: –°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–µ –ø–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- `MIN_SCORE_WEEK = 0.59` (59 –∏–∑ 100?)
- `MIN_SCORE_MONTH = 0.59`

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è scores –≤ –ë–î

### 2. –†–∞–∑–ª–∏—á–∏—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –¥–∞–Ω–Ω—ã—Ö
- –°—Ç–∞—Ä–∞—è: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `prediction`, `prediction_proba`
- –ù–æ–≤–∞—è: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç scores –∏ `recommended_action`

## üìã –ü–õ–ê–ù –ú–ò–ì–†–ê–¶–ò–ò

### –®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω scores
SELECT 
    MIN(score_week) as min_week,
    MAX(score_week) as max_week,
    AVG(score_week) as avg_week,
    MIN(score_month) as min_month,
    MAX(score_month) as max_month,
    AVG(score_month) as avg_month
FROM fas.scoring_history
WHERE created_at > NOW() - INTERVAL '1 day';
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
–í —Ñ–∞–π–ª–µ `.env`:
```env
# –ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è fas.scoring_history
USE_SCORING_HISTORY=true
MIN_SCORE_WEEK=59       # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
MIN_SCORE_MONTH=59      # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
SKIP_NO_TRADE=true      # –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–∏–≥–Ω–∞–ª—ã NO_TRADE
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ main.py
–ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤:
```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥
signals = await self.db.signals.get_unprocessed_signals(limit)

# –ù–æ–≤—ã–π –∫–æ–¥
if self.db.use_new_signal_source:
    signals = await self.db.signals_v2.get_unprocessed_signals_legacy(limit)
else:
    signals = await self.db.signals.get_unprocessed_signals(limit)
```

### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `test_new_signal_source.py`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
3. –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—É—é —Ç–æ—Ä–≥–æ–≤–ª—é –Ω–∞ testnet

### –®–∞–≥ 5: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
1. –í–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
2. –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Å–∏–≥–Ω–∞–ª–æ–≤
3. –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### –§–∞–π–ª—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
1. ‚úÖ `database/connection.py` - –¥–æ–±–∞–≤–ª–µ–Ω signals_v2
2. ‚ö†Ô∏è `main.py` - –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
3. ‚ö†Ô∏è `trading/signal_processor.py` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–æ–≥–∏–∫–µ:
- –°–∏–≥–Ω–∞–ª—ã —Ç–µ–ø–µ—Ä—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –ø–æ `signal_id` (fas.scoring_history.id)
- –í–º–µ—Å—Ç–æ `prediction_id` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `signal_id`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ scores –≤–º–µ—Å—Ç–æ prediction_proba

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –ò–°–¢–û–ß–ù–ò–ö–û–í

| –ü–∞—Ä–∞–º–µ—Ç—Ä | smart_ml.predictions | fas.scoring_history |
|----------|---------------------|-------------------|
| –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å | –£—Å—Ç–∞—Ä–µ–≤—à–∞—è | –ê–∫—Ç—É–∞–ª—å–Ω–∞—è |
| –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ | –¢—Ä–µ–±—É–µ—Ç JOIN | –°–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è |
| –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è | –ü–æ prediction_proba | –ü–æ scores |
| –î–∞–Ω–Ω—ã–µ | –ë–∏–Ω–∞—Ä–Ω—ã–µ (BUY/SELL) | –î–µ—Ç–∞–ª—å–Ω—ã–µ scores |
| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ | –ù–µ—Ç | recommended_action |

## ‚úîÔ∏è –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–°–†–û–ß–ù–û**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è scores –≤ fas.scoring_history
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Ä–æ–≥–∏**: MIN_SCORE_WEEK –∏ MIN_SCORE_MONTH –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å**: –ù–∞ testnet –ø–µ—Ä–µ–¥ production
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç—å –∑–∞ –∫–∞—á–µ—Å—Ç–≤–æ–º –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
5. **–û—Ç–∫–∞—Ç**: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å—Ç–∞—Ä—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
- –ò–º–µ—Ç—å –±–æ–ª–µ–µ –≥–∏–±–∫—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å–∏–≥–Ω–∞–ª–æ–≤
- –†–∞–±–æ—Ç–∞—Ç—å –±—ã—Å—Ç—Ä–µ–µ (–º–µ–Ω—å—à–µ JOIN –æ–ø–µ—Ä–∞—Ü–∏–π)
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∞–Ω–∞–ª–∏–∑–∞ (patterns, combinations)

## üìù –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
python test_new_signal_source.py

# 2. –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î
python analyze_db_structure.py

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –Ω–æ–≤—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º
USE_SCORING_HISTORY=true python main.py

# 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
tail -f ats_system.log | grep "scoring_history"
```

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏!** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.