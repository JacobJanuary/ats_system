<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS 2.0 Position Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .protection-high { background: linear-gradient(90deg, #10b981 0%, #34d399 100%); }
        .protection-medium { background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%); }
        .protection-low { background: linear-gradient(90deg, #ef4444 0%, #f87171 100%); }
        .flash-update { animation: flash 1s ease-in-out; }
        @keyframes flash { 
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(59, 130, 246, 0.2); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <div class="bg-gray-800 shadow-lg border-b border-gray-700">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-blue-400">ATS 2.0 Position Monitor</h1>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></div>
                            <span class="text-sm">{{ wsConnected ? 'Connected' : 'Disconnected' }}</span>
                        </div>
                        <span class="text-sm text-gray-400">{{ currentTime }}</span>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mt-4">
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <div class="text-xs text-gray-400">Open Positions</div>
                        <div class="text-xl font-bold text-blue-400">{{ stats.open_positions || 0 }}</div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <div class="text-xs text-gray-400">Unrealized PnL</div>
                        <div class="text-xl font-bold" :class="(stats.total_unrealized_pnl || 0) >= 0 ? 'text-green-400' : 'text-red-400'">
                            ${{ formatNumber(stats.total_unrealized_pnl || 0) }}
                        </div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <div class="text-xs text-gray-400">Today's PnL</div>
                        <div class="text-xl font-bold" :class="(stats.today_realized_pnl || 0) >= 0 ? 'text-green-400' : 'text-red-400'">
                            ${{ formatNumber(stats.today_realized_pnl || 0) }}
                        </div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <div class="text-xs text-gray-400">Win Rate Today</div>
                        <div class="text-xl font-bold" :class="stats.today_win_rate >= 50 ? 'text-green-400' : 'text-yellow-400'">
                            {{ stats.today_win_rate || 0 }}%
                        </div>
                        <div class="text-xs text-gray-500">{{ stats.today_wins || 0 }}W / {{ stats.today_losses || 0 }}L</div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <div class="text-xs text-gray-400">Protected (SL)</div>
                        <div class="text-xl font-bold text-yellow-400">{{ stats.protected_with_sl || 0 }}</div>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <div class="text-xs text-gray-400">Trailing Stop</div>
                        <div class="text-xl font-bold text-purple-400">{{ stats.protected_with_trailing || 0 }}</div>
                    </div>
                </div>
                
                <!-- Health Status -->
                <div class="flex gap-2 mt-3" v-if="Object.keys(health.components || {}).length > 0">
                    <div v-for="(status, component) in health.components" :key="component" 
                         class="flex items-center gap-1 px-2 py-1 rounded text-xs"
                         :class="status.status === 'healthy' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'">
                        <div class="w-2 h-2 rounded-full" 
                             :class="status.status === 'healthy' ? 'bg-green-500' : 'bg-red-500'"></div>
                        {{ component }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-wrap gap-3">
                <select v-model="filters.exchange" @change="loadPositions" 
                        class="px-4 py-2 bg-gray-800 border border-gray-700 rounded text-sm">
                    <option value="">All Exchanges</option>
                    <option value="binance">Binance</option>
                    <option value="bybit">Bybit</option>
                </select>
                
                <select v-model="filters.status" @change="loadPositions" 
                        class="px-4 py-2 bg-gray-800 border border-gray-700 rounded text-sm">
                    <option value="OPEN">Open</option>
                    <option value="CLOSED">Closed</option>
                    <option value="">All</option>
                </select>
                
                <input v-model="filters.symbol" @input="loadPositions" 
                       placeholder="Symbol filter..." 
                       class="px-4 py-2 bg-gray-800 border border-gray-700 rounded text-sm flex-1">
                
                <button @click="loadPositions" 
                        class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                    Refresh
                </button>
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" v-model="autoRefresh" id="autoRefresh" class="rounded">
                    <label for="autoRefresh" class="text-sm">Auto-refresh</label>
                </div>
            </div>
        </div>
        
        <!-- Positions Table -->
        <div class="max-w-7xl mx-auto px-4">
            <div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-900">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Exchange</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Symbol</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Side</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Entry</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Current</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Change</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Size</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Lev</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">PnL</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Protection</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase">Updated</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <tr v-for="position in positions" :key="position.id" 
                                :class="{'flash-update': isRecentlyUpdated(position.last_update)}"
                                class="hover:bg-gray-750 transition-colors">
                                <td class="px-3 py-3">
                                    <span class="px-2 py-1 text-xs rounded font-medium" 
                                          :class="position.exchange === 'binance' ? 'bg-yellow-900 text-yellow-300' : 'bg-blue-900 text-blue-300'">
                                        {{ position.exchange }}
                                    </span>
                                </td>
                                <td class="px-3 py-3 font-medium text-sm">{{ position.symbol }}</td>
                                <td class="px-3 py-3">
                                    <span class="px-2 py-1 text-xs rounded font-medium"
                                          :class="position.side === 'LONG' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'">
                                        {{ position.side }}
                                    </span>
                                </td>
                                <td class="px-3 py-3 text-sm">${{ formatPrice(position.entry_price) }}</td>
                                <td class="px-3 py-3 text-sm">${{ formatPrice(position.current_price) }}</td>
                                <td class="px-3 py-3 text-sm font-medium" 
                                    :class="position.price_change_percent >= 0 ? 'text-green-400' : 'text-red-400'">
                                    {{ position.price_change_percent > 0 ? '+' : '' }}{{ position.price_change_percent }}%
                                </td>
                                <td class="px-3 py-3 text-sm">{{ formatNumber(position.quantity) }}</td>
                                <td class="px-3 py-3 text-sm">{{ position.leverage }}x</td>
                                <td class="px-3 py-3 font-medium text-sm" 
                                    :class="(position.unrealized_pnl || 0) >= 0 ? 'text-green-400' : 'text-red-400'">
                                    ${{ formatNumber(position.unrealized_pnl || 0) }}
                                </td>
                                <td class="px-3 py-3">
                                    <div class="flex items-center gap-1">
                                        <div class="w-16 bg-gray-700 rounded-full h-2">
                                            <div class="h-2 rounded-full transition-all duration-300" 
                                                 :class="getProtectionClass(position.protection_score)"
                                                 :style="{width: position.protection_score + '%'}">
                                            </div>
                                        </div>
                                        <span class="text-xs text-gray-500">{{ position.protection_score }}%</span>
                                    </div>
                                    <div class="flex gap-1 mt-1">
                                        <span v-if="position.has_stop_loss" 
                                              class="text-xs bg-red-900 text-red-300 px-1 rounded" 
                                              :title="'SL: $' + formatPrice(position.stop_loss_price)">SL</span>
                                        <span v-if="position.has_take_profit" 
                                              class="text-xs bg-green-900 text-green-300 px-1 rounded"
                                              :title="'TP: $' + formatPrice(position.take_profit_price)">TP</span>
                                        <span v-if="position.has_trailing_stop" 
                                              class="text-xs bg-purple-900 text-purple-300 px-1 rounded"
                                              :title="'TS: ' + position.trailing_stop_distance + '%'">TS</span>
                                    </div>
                                </td>
                                <td class="px-3 py-3 text-xs text-gray-500">
                                    {{ formatTime(position.last_update) }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div v-if="positions.length === 0" class="text-center py-8 text-gray-500">
                        No positions found
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Balances -->
        <div class="max-w-7xl mx-auto px-4 py-4" v-if="Object.keys(balances).length > 0">
            <h2 class="text-xl font-bold mb-4 text-blue-400">Account Balances</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div v-for="(data, exchange) in balances" :key="exchange" 
                     class="bg-gray-800 rounded-lg shadow-xl p-4">
                    <h3 class="font-bold mb-2 text-lg">{{ exchange.toUpperCase() }}</h3>
                    <div class="text-sm text-gray-400 mb-3">
                        Total Value: <span class="text-white font-bold">${{ formatNumber(data.total_usd || 0) }}</span>
                    </div>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        <div v-for="balance in data.balances" :key="balance.asset" 
                             class="flex justify-between text-sm bg-gray-700 rounded px-3 py-2">
                            <span class="font-medium">{{ balance.asset }}</span>
                            <div class="text-right">
                                <div>{{ formatNumber(balance.total) }}</div>
                                <div class="text-xs text-gray-500" v-if="balance.in_usd">
                                    ${{ formatNumber(balance.in_usd) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    positions: [],
                    balances: {},
                    stats: {},
                    health: {},
                    filters: {
                        exchange: '',
                        status: 'OPEN',
                        symbol: ''
                    },
                    ws: null,
                    wsConnected: false,
                    autoRefresh: true,
                    currentTime: '',
                    updateTimestamps: {}
                }
            },
            mounted() {
                this.loadPositions();
                this.loadBalances();
                this.loadStats();
                this.loadHealth();
                this.connectWebSocket();
                this.updateTime();
                
                // Auto refresh
                setInterval(() => {
                    this.updateTime();
                    if (this.autoRefresh && !this.wsConnected) {
                        this.loadPositions();
                        this.loadStats();
                    }
                }, 5000);
                
                // Health check
                setInterval(() => {
                    this.loadHealth();
                }, 30000);
            },
            methods: {
                async loadPositions() {
                    const params = new URLSearchParams(this.filters);
                    const response = await fetch(`/api/positions?${params}`);
                    const data = await response.json();
                    this.positions = data.positions;
                },
                
                async loadBalances() {
                    const response = await fetch('/api/balances');
                    this.balances = await response.json();
                },
                
                async loadStats() {
                    const response = await fetch('/api/stats');
                    this.stats = await response.json();
                },
                
                async loadHealth() {
                    try {
                        const response = await fetch('/api/health');
                        this.health = await response.json();
                    } catch (e) {
                        console.error('Failed to load health:', e);
                    }
                },
                
                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        this.wsConnected = true;
                        console.log('WebSocket connected');
                    };
                    
                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        
                        if (message.type === 'position_update') {
                            // Update positions with animation
                            message.data.forEach(update => {
                                const index = this.positions.findIndex(p => p.id === update.id);
                                if (index !== -1) {
                                    this.positions[index] = update;
                                    this.updateTimestamps[update.id] = Date.now();
                                } else if (this.filters.status === 'OPEN') {
                                    // New position
                                    this.positions.unshift(update);
                                    this.updateTimestamps[update.id] = Date.now();
                                }
                            });
                        } else if (message.type === 'stats_update') {
                            this.stats = message.data;
                        }
                    };
                    
                    this.ws.onclose = () => {
                        this.wsConnected = false;
                        console.log('WebSocket disconnected');
                        // Reconnect after 5 seconds
                        setTimeout(() => this.connectWebSocket(), 5000);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                },
                
                formatNumber(num) {
                    if (num === null || num === undefined) return '0.00';
                    return parseFloat(num).toFixed(2);
                },
                
                formatPrice(price) {
                    if (!price) return '0.00';
                    // Format price with appropriate decimals
                    if (price > 1000) return parseFloat(price).toFixed(0);
                    if (price > 10) return parseFloat(price).toFixed(2);
                    if (price > 1) return parseFloat(price).toFixed(3);
                    if (price > 0.01) return parseFloat(price).toFixed(4);
                    return parseFloat(price).toFixed(6);
                },
                
                formatTime(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diff = (now - date) / 1000;
                    
                    if (diff < 60) return `${Math.floor(diff)}s ago`;
                    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
                    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
                    return date.toLocaleDateString();
                },
                
                isRecentlyUpdated(timestamp) {
                    if (!timestamp) return false;
                    const date = new Date(timestamp);
                    const now = new Date();
                    return (now - date) < 3000;
                },
                
                getProtectionClass(score) {
                    if (score >= 66) return 'protection-high';
                    if (score >= 33) return 'protection-medium';
                    return 'protection-low';
                },
                
                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleTimeString();
                }
            }
        }).mount('#app');
    </script>
</body>
</html>